pipeline {
    agent {
        dockerfile {     
            args '-u root -v /home/ubuntu/ansible/env_1:/ansible/ -v /home/ubuntu/ansible/env_1/ansible.cfg:/etc/ansible/ansible.cfg'
        }
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', credentialsId: 'github-key', url: 'git@github.com:unicum0212/ansible-roles-petclinic.git'
            }
        }
        stage("Pull Source Code And Test App") {
            steps {
                sh 'ansible-playbook /ansible/playbooks/tests-petclinic.yml'
            }
        }
        stage("Deploy App") {
            steps {
                sh 'ansible-playbook /ansible/playbooks/deploy-petclinic.yml'
            }
        }
    }
}
